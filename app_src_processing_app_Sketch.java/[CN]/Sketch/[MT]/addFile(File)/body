{
  String filename=sourceFile.getName();
  File destFile=null;
  boolean addingCode=false;
  boolean replacement=false;
  if (filename.toLowerCase().endsWith(".class") || filename.toLowerCase().endsWith(".jar") || filename.toLowerCase().endsWith(".dll")|| filename.toLowerCase().endsWith(".jnilib")|| filename.toLowerCase().endsWith(".so")) {
    if (!codeFolder.exists())     codeFolder.mkdirs();
    destFile=new File(codeFolder,filename);
  }
 else   if (filename.toLowerCase().endsWith(".pde") || filename.toLowerCase().endsWith(".java")) {
    destFile=new File(this.folder,filename);
    addingCode=true;
  }
 else {
    if (!dataFolder.exists())     dataFolder.mkdirs();
    destFile=new File(dataFolder,filename);
  }
  if (destFile.exists()) {
    Object[] options={"OK","Cancel"};
    String prompt="Replace the existing version of " + filename + "?";
    int result=JOptionPane.showOptionDialog(editor,prompt,"Replace",JOptionPane.YES_NO_OPTION,JOptionPane.QUESTION_MESSAGE,null,options,options[0]);
    if (result == JOptionPane.YES_OPTION) {
      replacement=true;
    }
 else {
      return false;
    }
  }
  if (!addingCode && sourceFile.equals(destFile)) {
    Base.showWarning("You can't fool me","This file has already been copied to the\n" + "location from which where you're trying to add it.\n" + "I ain't not doin nuthin'.",null);
    return false;
  }
  if (!sourceFile.equals(destFile)) {
    try {
      Base.copyFile(sourceFile,destFile);
    }
 catch (    IOException e) {
      Base.showWarning("Error adding file","Could not add '" + filename + "' to the sketch.",e);
      return false;
    }
  }
  if (addingCode) {
    String newName=destFile.getName();
    int newFlavor=-1;
    if (newName.toLowerCase().endsWith(".pde")) {
      newName=newName.substring(0,newName.length() - 4);
      newFlavor=PDE;
    }
 else {
      newName=newName.substring(0,newName.length() - 5);
      newFlavor=JAVA;
    }
    SketchCode newCode=new SketchCode(newName,destFile,newFlavor);
    if (replacement) {
      replaceCode(newCode);
    }
 else {
      insertCode(newCode);
      sortCode();
    }
    setCurrent(newName);
    editor.header.repaint();
    if (editor.untitled) {
      current.modified=true;
    }
  }
 else {
    if (editor.untitled) {
      code[0].modified=true;
    }
  }
  return true;
}
