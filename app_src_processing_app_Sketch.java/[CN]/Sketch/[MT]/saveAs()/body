{
  String newParentDir=null;
  String newName=null;
  FileDialog fd=new FileDialog(editor,"Save sketch folder as...",FileDialog.SAVE);
  if (isReadOnly() || isUntitled()) {
    fd.setDirectory(Preferences.get("sketchbook.path"));
  }
 else {
    fd.setDirectory(folder.getParent());
  }
  String oldName=folder.getName();
  fd.setFile(oldName);
  fd.setVisible(true);
  newParentDir=fd.getDirectory();
  newName=fd.getFile();
  if (newName == null)   return false;
  newName=Sketch.checkName(newName);
  File newFolder=new File(newParentDir,newName);
  for (int i=1; i < codeCount; i++) {
    if (newName.equals(code[i].getPrettyName())) {
      Base.showMessage("Nope","You can't save the sketch as \"" + newName + "\"\n"+ "because the sketch already has a tab with that name.");
      return false;
    }
  }
  if (newFolder.equals(folder)) {
    return save();
  }
  try {
    String newPath=newFolder.getCanonicalPath() + File.separator;
    String oldPath=folder.getCanonicalPath() + File.separator;
    if (newPath.indexOf(oldPath) == 0) {
      Base.showWarning("How very Borges of you","You cannot save the sketch into a folder\n" + "inside itself. This would go on forever.",null);
      return false;
    }
  }
 catch (  IOException e) {
  }
  if (newFolder.exists()) {
    Base.removeDir(newFolder);
  }
  newFolder.mkdirs();
  if (current.isModified()) {
    current.setProgram(editor.getText());
  }
  for (int i=1; i < codeCount; i++) {
    File newFile=new File(newFolder,code[i].getFileName());
    code[i].saveAs(newFile);
  }
  if (dataFolder.exists()) {
    File newDataFolder=new File(newFolder,"data");
    Base.copyDir(dataFolder,newDataFolder);
  }
  if (codeFolder.exists()) {
    File newCodeFolder=new File(newFolder,"code");
    Base.copyDir(codeFolder,newCodeFolder);
  }
  File customHtml=new File(folder,"applet.html");
  if (customHtml.exists()) {
    File newHtml=new File(newFolder,"applet.html");
    Base.copyFile(customHtml,newHtml);
  }
  File newFile=new File(newFolder,newName + ".pde");
  code[0].saveAs(newFile);
  editor.handleOpenUnchecked(newFile.getPath(),currentIndex,editor.getSelectionStart(),editor.getSelectionStop(),editor.getScrollPosition());
  editor.base.rebuildSketchbookMenus();
  setUntitled(false);
  return true;
}
