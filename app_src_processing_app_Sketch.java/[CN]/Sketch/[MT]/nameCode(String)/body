{
  ensureExistence();
  if (renamingCode && newName.equalsIgnoreCase(current.name)) {
    return;
  }
  if (newName.trim().equals("")) {
    return;
  }
  if (newName.trim().equals(".java") || newName.trim().equals(".pde")) {
    return;
  }
  String newFilename=null;
  int newFlavor=0;
  if (newName.endsWith(".pde")) {
    newFilename=newName;
    newName=newName.substring(0,newName.length() - 4);
    newFlavor=PDE;
  }
 else   if (newName.endsWith(".java")) {
    if (renamingCode && (code[0] == current)) {
      Base.showWarning("Problem with rename","The main .pde file cannot be .java file.\n" + "(It may be time for your to graduate to a\n" + "\"real\" programming environment)",null);
      return;
    }
    newFilename=newName;
    newName=newName.substring(0,newName.length() - 5);
    newFlavor=JAVA;
  }
 else {
    newFilename=newName + ".pde";
    newFlavor=PDE;
  }
  if (newName.indexOf('.') != -1) {
    newName=Sketch.sanitizedName(newName);
    newFilename=newName + ((newFlavor == PDE) ? ".pde" : ".java");
  }
  File newFile=new File(folder,newFilename);
  if (newFile.exists()) {
    Base.showMessage("Nope","A file named \"" + newFile + "\" already exists\n"+ "in \""+ folder.getAbsolutePath()+ "\"");
    return;
  }
  File newFileHidden=new File(folder,newFilename + ".x");
  if (newFileHidden.exists()) {
    Base.showMessage("No Way","A hidden tab with the same name already exists.\n" + "Use \"Unhide\" to bring it back.");
    return;
  }
  if (renamingCode) {
    if (currentIndex == 0) {
      File newFolder=new File(folder.getParentFile(),newName);
      if (newFolder.exists()) {
        Base.showWarning("Cannot Rename","Sorry, a sketch (or folder) named " + "\"" + newName + "\" already exists.",null);
        return;
      }
      if (current.modified) {
        current.program=editor.getText();
        try {
          current.save();
        }
 catch (        Exception e) {
          Base.showWarning("Error","Could not rename the sketch. (0)",e);
          return;
        }
      }
      if (!current.file.renameTo(newFile)) {
        Base.showWarning("Error","Could not rename \"" + current.file.getName() + "\" to \""+ newFile.getName()+ "\"",null);
        return;
      }
      try {
        for (int i=1; i < codeCount; i++) {
          code[i].save();
        }
      }
 catch (      Exception e) {
        Base.showWarning("Error","Could not rename the sketch. (1)",e);
        return;
      }
      boolean success=folder.renameTo(newFolder);
      if (!success) {
        Base.showWarning("Error","Could not rename the sketch. (2)",null);
        return;
      }
      File mainFile=new File(newFolder,newName + ".pde");
      mainFilename=mainFile.getAbsolutePath();
      editor.handleOpenUnchecked(mainFilename,currentIndex,editor.textarea.getSelectionStart(),editor.textarea.getSelectionEnd(),editor.textarea.getScrollPosition());
      editor.base.rebuildMenusAsync();
    }
 else {
      if (!current.file.renameTo(newFile)) {
        Base.showWarning("Error","Could not rename \"" + current.file.getName() + "\" to \""+ newFile.getName()+ "\"",null);
        return;
      }
      current.name=newName;
      current.file=newFile;
      current.flavor=newFlavor;
    }
  }
 else {
    try {
      newFile.createNewFile();
    }
 catch (    IOException e) {
      Base.showWarning("Error","Could not create the file \"" + newFile + "\"\n"+ "in \""+ folder.getAbsolutePath()+ "\"",e);
      return;
    }
    SketchCode newCode=new SketchCode(newName,newFile,newFlavor);
    insertCode(newCode);
  }
  sortCode();
  setCurrent(newName);
  editor.header.rebuild();
  Toolkit.getDefaultToolkit().sync();
}
