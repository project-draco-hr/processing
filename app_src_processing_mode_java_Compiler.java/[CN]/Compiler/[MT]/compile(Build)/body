{
  SketchException exception=null;
  boolean success=false;
  String baseCommand[]=new String[]{"-Xemacs","-source","1.5","-target","1.5","-classpath",build.getClassPath(),"-nowarn","-d",build.getBinFolder().getAbsolutePath()};
  String[] sourceFiles=Base.listFiles(build.getSrcFolder(),false,".java");
  String[] command=PApplet.concat(baseCommand,sourceFiles);
  try {
    final StringBuffer errorBuffer=new StringBuffer();
    Writer internalWriter=new Writer(){
      public void write(      char[] buf,      int off,      int len){
        errorBuffer.append(buf,off,len);
      }
      public void flush(){
      }
      public void close(){
      }
    }
;
    PrintWriter writer=new PrintWriter(internalWriter);
    CompilationProgress progress=null;
    PrintWriter outWriter=new PrintWriter(System.out);
    success=BatchCompiler.compile(command,outWriter,writer,progress);
    writer.flush();
    writer.close();
    BufferedReader reader=new BufferedReader(new StringReader(errorBuffer.toString()));
    String line=null;
    while ((line=reader.readLine()) != null) {
      String errorFormat="([\\w\\d_]+.java):(\\d+):\\s*(.*):\\s*(.*)\\s*";
      String[] pieces=PApplet.match(line,errorFormat);
      if (pieces == null) {
        exception=new SketchException("Cannot parse error text: " + line);
        exception.hideStackTrace();
        System.err.println(line);
        while ((line=reader.readLine()) != null) {
          System.err.println(line);
        }
        break;
      }
      String dotJavaFilename=pieces[1];
      int dotJavaLineIndex=PApplet.parseInt(pieces[2]) - 1;
      String errorMessage=pieces[4];
      exception=build.placeException(errorMessage,dotJavaFilename,dotJavaLineIndex);
      if (exception == null) {
        exception=new SketchException(errorMessage);
      }
      if (errorMessage.startsWith("The import ") && errorMessage.endsWith("cannot be resolved")) {
        String what=errorMessage.substring("The import ".length());
        what=what.substring(0,what.indexOf(' '));
        System.err.println("Note that release 1.0, libraries must be " + "installed in a folder named 'libraries' " + "inside the 'sketchbook' folder.");
        exception.setMessage("The package " + "\u201C" + what + "\u201D"+ " does not exist. "+ "You might be missing a library.");
      }
 else       if (errorMessage.endsWith("cannot be resolved to a type")) {
        String what=errorMessage.substring(0,errorMessage.indexOf(' '));
        if (what.equals("BFont") || what.equals("BGraphics") || what.equals("BImage")) {
          handleCrustyCode(exception);
        }
 else {
          exception.setMessage("Cannot find a class or type " + "named \u201C" + what + "\u201D");
        }
      }
 else       if (errorMessage.endsWith("cannot be resolved")) {
        String what=errorMessage.substring(0,errorMessage.indexOf(' '));
        if (what.equals("LINE_LOOP") || what.equals("LINE_STRIP") || what.equals("framerate")) {
          handleCrustyCode(exception);
        }
 else {
          exception.setMessage("Cannot find anything " + "named \u201C" + what + "\u201D");
        }
      }
 else       if (errorMessage.startsWith("Duplicate")) {
      }
 else {
        String[] parts=null;
        String undefined="The method (\\S+\\(.*\\)) is undefined for the type (.*)";
        parts=PApplet.match(errorMessage,undefined);
        if (parts != null) {
          if (parts[1].equals("framerate(int)") || parts[1].equals("push()")) {
            handleCrustyCode(exception);
          }
 else {
            String mess="The function " + parts[1] + " does not exist.";
            exception.setMessage(mess);
          }
          break;
        }
      }
      if (exception != null) {
        exception.hideStackTrace();
        break;
      }
    }
  }
 catch (  IOException e) {
    String bigSigh="Error while compiling. (" + e.getMessage() + ")";
    exception=new SketchException(bigSigh);
    e.printStackTrace();
    success=false;
  }
  if (exception != null)   throw exception;
  return success;
}
