{
  if (state != State.NOT_RUNNING) {
    String illegal="You can't launch an emulator whose state is " + state;
    throw new IllegalStateException(illegal);
  }
  String portString=Preferences.get("android.emulator.port");
  if (portString == null) {
    portString="5566";
    Preferences.set("android.emulator.port",portString);
  }
  final String[] cmd=new String[]{"emulator","-avd",AVD.defaultAVD.name,"-port",portString};
  if (Base.DEBUG) {
    System.out.println(processing.core.PApplet.join(cmd," "));
  }
  final Process p=Runtime.getRuntime().exec(cmd);
  ProcessRegistry.watch(p);
  setState(State.WAITING_FOR_BOOT);
  final String title=PApplet.join(cmd,' ');
  StreamPump outie=new StreamPump(p.getInputStream(),"out: " + title);
  outie.addTarget(new LineProcessor(){
    public void processLine(    String line){
      if (line.contains("the cache image is used by another emulator")) {
      }
 else {
        System.out.println(title + ": " + line);
      }
    }
  }
);
  StreamPump errie=new StreamPump(p.getErrorStream(),"err: " + title);
  errie.addTarget(new LineProcessor(){
    public void processLine(    String line){
      if (line.contains("This application, or a library it uses, is using NSQuickDrawView")) {
      }
 else {
        System.err.println(title + ": " + line);
      }
    }
  }
);
  final CountDownLatch latch=new CountDownLatch(1);
  new Thread(new Runnable(){
    public void run(){
      try {
        while (state == State.WAITING_FOR_BOOT) {
          if (processing.app.Base.DEBUG) {
            System.out.println("sleeping for 2 seconds " + new java.util.Date().toString());
          }
          Thread.sleep(2000);
          for (          final String device : Devices.list()) {
            if (device.contains("emulator")) {
              setState(State.RUNNING);
              return;
            }
          }
        }
        System.err.println("EmulatorController: Emulator never booted. " + state);
      }
 catch (      Exception e) {
        System.err.println("Exception while waiting for emulator to boot:");
        e.printStackTrace();
        p.destroy();
      }
 finally {
        latch.countDown();
      }
    }
  }
,"EmulatorController: Wait for emulator to boot").start();
  new Thread(new Runnable(){
    public void run(){
      try {
        final int result=p.waitFor();
        if (result != 0) {
          System.err.println("Emulator process exited with status " + result + ".");
          setState(State.NOT_RUNNING);
        }
      }
 catch (      InterruptedException e) {
        System.err.println("Emulator was interrupted.");
        setState(State.NOT_RUNNING);
      }
 finally {
        p.destroy();
        ProcessRegistry.unwatch(p);
      }
    }
  }
,"EmulatorController: emulator process waitFor()").start();
  try {
    latch.await();
  }
 catch (  final InterruptedException drop) {
    System.err.println("Interrupted while waiting for emulator to launch.");
  }
}
