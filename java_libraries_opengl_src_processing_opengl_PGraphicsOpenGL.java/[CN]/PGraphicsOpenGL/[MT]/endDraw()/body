{
  report("top endDraw()");
  if (flushMode == FLUSH_WHEN_FULL || flushMode == FLUSH_AFTER_TRANSFORMATION) {
    flush();
  }
  if (!drawing) {
    System.err.println("P3D: Cannot call endDraw() before beginDraw().");
    return;
  }
  gl.glViewport(viewport[0],viewport[1],viewport[2],viewport[3]);
  if (primarySurface) {
    gl.glFlush();
    if (drawable != null) {
      drawable.swapBuffers();
      releaseContext();
    }
  }
 else {
    if (offscreenMultisample) {
      offscreenFramebufferMultisample.copy(offscreenFramebuffer);
    }
    popFramebuffer();
    ogl.restoreGLState();
  }
  drawing=false;
  report("bot endDraw()");
}
