{
  if (drawing) {
    System.err.println("P3D: Already called beginDraw().");
    return;
  }
  if (primarySurface && drawable != null) {
    drawable.setRealized(parent.isDisplayable());
    if (parent.isDisplayable()) {
      drawable.setRealized(true);
    }
 else {
      return;
    }
    detainContext();
  }
  updateGLInterfaces();
  if (!glParamsRead) {
    getGLParameters();
  }
  if (!settingsInited) {
    defaultSettings();
  }
  if (lineShader == null) {
    lineShader=new PShader(parent);
    lineShader.loadVertexShaderSource(lineShaderVert);
    lineShader.loadFragmentShaderSource(lineShaderFrag);
    lineShader.setup();
  }
  if (pointShader == null) {
    pointShader=new PShader(parent);
    pointShader.loadVertexShaderSource(pointShaderVert);
    pointShader.loadFragmentShaderSource(pointShaderFrag);
    pointShader.setup();
  }
  report("top beginDraw()");
  if (!primarySurface) {
    ogl.saveGLState();
    ogl.disableLights();
  }
  vertexBuffer.rewind();
  colorBuffer.rewind();
  normalBuffer.rewind();
  for (int t=0; t < numTexBuffers; t++) {
    texCoordBuffer[t].rewind();
  }
  if (USE_GEO_BUFFER) {
    if (geoBuffer == null)     geoBuffer=new GeometryBuffer();
    if (GEO_BUFFER_ACCUM_ALL) {
      geoBuffer.init(TRIANGLES);
    }
    GEO_BUFFER_COUNT=0;
    GEO_BUFFER_SIZE=0;
  }
  noTexture();
  screenBlend(BLEND);
  textureBlend(BLEND);
  if (hints[DISABLE_DEPTH_TEST]) {
    gl.glDisable(GL.GL_DEPTH_TEST);
  }
 else {
    gl.glEnable(GL.GL_DEPTH_TEST);
  }
  gl.glDepthFunc(GL.GL_LEQUAL);
  if (hints[DISABLE_DEPTH_MASK]) {
    gl.glDepthMask(false);
  }
 else {
    gl.glDepthMask(true);
  }
  gl.glGetIntegerv(GL.GL_VIEWPORT,viewport,0);
  gl.glViewport(0,0,width,height);
  if (resized) {
    background(0);
    if (texture != null) {
      this.removeCache(ogl);
      this.removeParams(ogl);
      texture=null;
      loadTexture();
    }
    resized=false;
  }
  if (sizeChanged) {
    camera();
    perspective();
    sizeChanged=false;
  }
 else {
    restoreCamera();
    restoreProjection();
  }
  noLights();
  lightFalloff(1,0,0);
  lightSpecular(0,0,0);
  gl.glFrontFace(GL.GL_CW);
  setSurfaceParams();
  shapeFirst=0;
  normalX=normalY=normalZ=0;
  if (primarySurface) {
  }
 else {
    pushFramebuffer();
    if (offscreenMultisample) {
      setFramebuffer(offscreenFramebufferMultisample);
      gl2x.glDrawBuffer(GL.GL_COLOR_ATTACHMENT0);
    }
 else {
      setFramebuffer(offscreenFramebuffer);
    }
  }
  gl.glClearColor(0,0,0,0);
  gl.glClear(GL.GL_DEPTH_BUFFER_BIT | GL.GL_STENCIL_BUFFER_BIT);
  drawing=true;
  report("bot beginDraw()");
}
