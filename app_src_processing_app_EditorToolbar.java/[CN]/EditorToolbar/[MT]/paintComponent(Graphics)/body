{
  if (buttons.size() == 0) {
    init();
  }
  Dimension size=getSize();
  if ((offscreen == null) || (size.width != width) || (size.height != height)) {
    if (Toolkit.highResDisplay()) {
      offscreen=createImage(size.width * 2,size.height * 2);
    }
 else {
      offscreen=createImage(size.width,size.height);
    }
    width=size.width;
    height=size.height;
    int offsetX=3;
    for (    Button b : buttons) {
      b.left=offsetX;
      if (b.gap) {
        b.left+=BUTTON_GAP;
      }
      b.right=b.left + BUTTON_WIDTH;
      offsetX=b.right;
    }
  }
  Graphics g=offscreen.getGraphics();
  Toolkit.prepareGraphics(g);
  g.setColor(hiding ? hideColor : bgColor);
  g.fillRect(0,0,width,height);
  if (!hiding) {
    mode.drawBackground(g,0);
  }
  for (  Button b : buttons) {
    g.drawImage(b.stateImage,b.left,0,BUTTON_WIDTH,Preferences.GRID_SIZE,null);
  }
  g.setColor(statusColor);
  g.setFont(statusFont);
  if (statusAscent == 0) {
    statusAscent=(int)Toolkit.getAscent(g);
  }
  if (rollover != null) {
    int statusY=(Preferences.GRID_SIZE + statusAscent) / 2;
    String status=shiftPressed ? rollover.titleShift : rollover.title;
    g.drawString(status,buttons.size() * BUTTON_WIDTH + 3 * BUTTON_GAP,statusY);
  }
  g.setFont(modeTextFont);
  FontMetrics metrics=g.getFontMetrics();
  if (modeTextAscent == 0) {
    modeTextAscent=(int)Toolkit.getAscent(g);
  }
  int modeTextWidth=metrics.stringWidth(modeTitle);
  final int modeGapWidth=8;
  final int modeBoxHeight=20;
  modeX2=getWidth() - 16;
  modeX1=modeX2 - (modeGapWidth + modeTextWidth + modeGapWidth+ ARROW_WIDTH+ modeGapWidth);
  modeY1=(getHeight() - modeBoxHeight) / 2;
  modeY2=modeY1 + modeBoxHeight;
  g.setColor(modeButtonColor);
  g.drawRect(modeX1,modeY1,modeX2 - modeX1,modeY2 - modeY1 - 1);
  g.drawString(modeTitle,modeX1 + modeGapWidth,modeY1 + (modeBoxHeight + modeTextAscent) / 2);
  g.drawImage(modeArrow,modeX2 - ARROW_WIDTH - modeGapWidth,modeY1 + (modeBoxHeight - ARROW_HEIGHT) / 2,ARROW_WIDTH,ARROW_HEIGHT,null);
  screen.drawImage(offscreen,0,0,size.width,size.height,null);
}
