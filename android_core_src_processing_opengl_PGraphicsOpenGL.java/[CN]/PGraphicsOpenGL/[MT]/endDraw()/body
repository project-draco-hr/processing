{
  report("top endDraw()");
  flush();
  if (!drawing) {
    showWarning("Cannot call endDraw() before beginDraw().");
    return;
  }
  if (primarySurface) {
    pgl.endOnscreenDraw(clearColorBuffer0);
    if (!pgl.initialized || parent.frameCount == 0) {
      saveSurfaceToPixels();
      restoreSurface=true;
    }
    pgl.glFlush();
  }
 else {
    if (offscreenMultisample) {
      offscreenFramebufferMultisample.copy(offscreenFramebuffer);
    }
    if (offscreenMultisample) {
      pushFramebuffer();
      setFramebuffer(offscreenFramebuffer);
    }
    pgl.glColorMask(false,false,false,true);
    pgl.glClearColor(0,0,0,1);
    pgl.glClear(PGL.GL_COLOR_BUFFER_BIT);
    pgl.glColorMask(true,true,true,true);
    if (offscreenMultisample) {
      popFramebuffer();
    }
    if (!pgl.initialized || !pgPrimary.pgl.initialized || parent.frameCount == 0) {
      saveSurfaceToPixels();
      restoreSurface=true;
    }
    popFramebuffer();
    pgl.endOffscreenDraw(pgPrimary.clearColorBuffer0);
    pgPrimary.restoreGL();
  }
  drawing=false;
  if (pgCurrent == pgPrimary) {
    pgCurrent=null;
  }
 else {
    pgCurrent=pgPrimary;
  }
  report("bot endDraw()");
}
