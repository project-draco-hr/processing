{
  final ArrayList<String> programImports=new ArrayList<String>();
  final ArrayList<String> codeFolderImports=new ArrayList<String>();
  foundMethods=new HashMap<String,Object>();
  if (!program.endsWith("\n")) {
    program+="\n";
  }
  checkForUnterminatedMultilineComment(program);
  if (Preferences.getBoolean("preproc.substitute_unicode")) {
    program=substituteUnicode(program);
  }
  final String importRegexp="(?:^|;)\\s*(import\\s+)((?:static\\s+)?\\S+)(\\s*;)";
  final Pattern importPattern=Pattern.compile(importRegexp);
  String scrubbed=scrubComments(program);
  Matcher m=importPattern.matcher(scrubbed);
  int offset=0;
  boolean found=false;
  do {
    found=m.find(offset);
    if (found) {
      String piece=m.group(1) + m.group(2) + m.group(3);
      int len=piece.length();
      if (!ignoreImport(m.group(2))) {
        programImports.add(m.group(2));
      }
      int start=m.start();
      int stop=start + len;
      program=program.substring(0,start) + program.substring(stop);
      scrubbed=scrubbed.substring(0,start) + scrubbed.substring(stop);
      offset=stop;
    }
  }
 while (found);
  if (codeFolderPackages != null) {
    for (    String item : codeFolderPackages) {
      codeFolderImports.add(item + ".*");
    }
  }
  final PrintWriter stream=new PrintWriter(out);
  final int headerOffset=writeImports(stream,programImports,codeFolderImports);
  return new PreprocessorResult(mode,headerOffset + 2,write(program,stream),programImports);
}
