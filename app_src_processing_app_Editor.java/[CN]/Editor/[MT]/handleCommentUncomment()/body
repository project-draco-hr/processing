{
  startCompoundEdit();
  String prefix=getCommentPrefix();
  int prefixLen=prefix.length();
  int startLine=textarea.getSelectionStartLine();
  int stopLine=textarea.getSelectionStopLine();
  int lastLineStart=textarea.getLineStartOffset(stopLine);
  int selectionStop=textarea.getSelectionStop();
  if (selectionStop == lastLineStart) {
    if (textarea.isSelectionActive()) {
      stopLine--;
    }
  }
  int length=textarea.getDocumentLength();
  boolean commented=true;
  for (int i=startLine; commented && (i <= stopLine); i++) {
    int pos=textarea.getLineStartOffset(i);
    if (pos + prefixLen > length) {
      commented=false;
    }
 else {
      String begin=textarea.getText(pos,prefixLen);
      commented=begin.equals(prefix);
    }
  }
  for (int line=startLine; line <= stopLine; line++) {
    int location=textarea.getLineStartOffset(line);
    if (commented) {
      textarea.select(location,location + prefixLen);
      if (textarea.getSelectedText().equals(prefix)) {
        textarea.setSelectedText("");
      }
    }
 else {
      textarea.select(location,location);
      textarea.setSelectedText(prefix);
    }
  }
  textarea.select(textarea.getLineStartOffset(startLine),textarea.getLineStopOffset(stopLine) - 1);
  stopCompoundEdit();
  sketch.setModified(true);
}
