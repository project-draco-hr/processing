{
  beginCompoundEdit();
  int startLine=textarea.getSelectionStartLine();
  int stopLine=textarea.getSelectionStopLine();
  int lastLineStart=textarea.getLineStartOffset(stopLine);
  int selectionStop=textarea.getSelectionStop();
  if (selectionStop == lastLineStart) {
    if (textarea.isSelectionActive()) {
      stopLine--;
    }
  }
  int length=textarea.getDocumentLength();
  boolean commented=true;
  for (int i=startLine; commented && (i <= stopLine); i++) {
    int pos=textarea.getLineStartOffset(i);
    if (pos + 2 > length) {
      commented=false;
    }
 else {
      String begin=textarea.getText(pos,2);
      commented=begin.equals("//");
    }
  }
  for (int line=startLine; line <= stopLine; line++) {
    int location=textarea.getLineStartOffset(line);
    if (commented) {
      textarea.select(location,location + 2);
      if (textarea.getSelectedText().equals("//")) {
        textarea.setSelectedText("");
      }
    }
 else {
      textarea.select(location,location);
      textarea.setSelectedText("//");
    }
  }
  textarea.select(textarea.getLineStartOffset(startLine),textarea.getLineStopOffset(stopLine) - 1);
  endCompoundEdit();
}
