{
  if (!editor.getSketch().isModified())   return false;
  isSaving=true;
  Sketch sc=editor.getSketch();
  boolean deleteOldSave=false;
  String oldSave=null;
  if (!autosaveDir.exists()) {
    autosaveDir=new File(sc.getFolder().getAbsolutePath(),"_autosave");
    autosaveDir.mkdir();
  }
 else {
    String prevSaves[]=Base.listFiles(autosaveDir,false);
    if (prevSaves.length > 0) {
      deleteOldSave=true;
      oldSave=prevSaves[0];
    }
  }
  String newParentDir=autosaveDir + File.separator + System.currentTimeMillis();
  String newName=sc.getName();
  String sanitaryName=Sketch.checkName(newName);
  File newFolder=new File(newParentDir,sanitaryName);
  if (!sanitaryName.equals(newName) && newFolder.exists()) {
    Base.showMessage("Cannot Save","A sketch with the cleaned name\n" + "???" + sanitaryName + "??? already exists.");
    isSaving=false;
    return false;
  }
  newName=sanitaryName;
  for (int i=1; i < sc.getCodeCount(); i++) {
    if (newName.equalsIgnoreCase(sc.getCode()[i].getPrettyName())) {
      Base.showMessage("Nope","You can't save the sketch as \"" + newName + "\"\n"+ "because the sketch already has a tab with that name.");
      isSaving=false;
      return false;
    }
  }
  if (newFolder.exists()) {
    Base.removeDir(newFolder);
  }
  newFolder.mkdirs();
  if (sc.getCurrentCode().isModified()) {
    sc.getCurrentCode().setProgram(editor.getText());
  }
  File[] copyItems=sc.getFolder().listFiles(new FileFilter(){
    public boolean accept(    File file){
      String name=file.getName();
      if (name.equals(".") || name.equals("..")) {
        return false;
      }
      for (      String ignorable : editor.getMode().getIgnorable()) {
        if (name.equals(ignorable)) {
          return false;
        }
      }
      for (      String ext : editor.getMode().getExtensions()) {
        if (name.endsWith(ext)) {
          return false;
        }
      }
      if (name.startsWith("screen-")) {
        return false;
      }
      return true;
    }
  }
);
  for (  File copyable : copyItems) {
    if (copyable.isDirectory()) {
      Base.copyDir(copyable,new File(newFolder,copyable.getName()));
    }
 else {
      Base.copyFile(copyable,new File(newFolder,copyable.getName()));
    }
  }
  for (int i=1; i < sc.getCodeCount(); i++) {
    File newFile=new File(newFolder,sc.getCode()[i].getFileName());
    sc.getCode()[i].saveAs(newFile);
  }
  File newFile=new File(newFolder,newName + ".pde");
  sc.getCode()[0].saveAs(newFile);
  if (deleteOldSave) {
    Base.removeDir(new File(oldSave));
  }
  isSaving=false;
  return true;
}
