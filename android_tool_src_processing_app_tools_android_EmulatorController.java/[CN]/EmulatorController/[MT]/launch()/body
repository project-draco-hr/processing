{
  if (state != State.NOT_RUNNING) {
    String illegal="You can't launch an emulator whose state is " + state;
    throw new IllegalStateException(illegal);
  }
  String portString=Preferences.get("android.emulator.port");
  if (portString == null) {
    portString="5566";
    Preferences.set("android.emulator.port",portString);
  }
  final String[] cmd=new String[]{"emulator","-avd",AVD.defaultAVD.name,"-port",portString,"-no-boot-anim"};
  final Process p=Runtime.getRuntime().exec(cmd);
  ProcessRegistry.watch(p);
  new StreamPump(p.getInputStream(),"emulator: ").addTarget(System.out).start();
  setState(State.WAITING_FOR_BOOT);
  final String title=PApplet.join(cmd,' ');
  StreamPump outie=new StreamPump(p.getInputStream(),"out: " + title);
  outie.addTarget(new LineProcessor(){
    public void processLine(    String line){
      if (line.contains("the cache image is used by another emulator")) {
      }
 else {
        System.out.println(title + ": " + line);
      }
    }
  }
);
  StreamPump errie=new StreamPump(p.getErrorStream(),"err: " + title);
  errie.addTarget(new LineProcessor(){
    public void processLine(    String line){
      if (line.contains("This application, or a library it uses, is using NSQuickDrawView")) {
      }
 else {
        System.err.println(title + ": " + line);
      }
    }
  }
);
  final CountDownLatch latch=new CountDownLatch(1);
  new Thread(new Runnable(){
    public void run(){
      try {
        while (state == State.WAITING_FOR_BOOT) {
          if (processing.app.Base.DEBUG) {
            System.out.println("sleeping for 2 seconds " + new java.util.Date().toString());
          }
          Thread.sleep(2000);
          for (          final String device : Environment.listDevices()) {
            if (device.contains("emulator")) {
              setState(State.RUNNING);
              return;
            }
          }
        }
        System.err.println("EmulatorController: Emulator never booted. " + state);
      }
 catch (      final Exception e) {
        System.err.println("While waiting for emulator to boot " + e);
        p.destroy();
      }
 finally {
        latch.countDown();
      }
    }
  }
,"EmulatorController: Wait for emulator to boot").start();
  new Thread(new Runnable(){
    public void run(){
      try {
        try {
          p.waitFor();
        }
 catch (        final InterruptedException e) {
          System.err.println("Emulator was interrupted.");
        }
 finally {
          p.destroy();
          ProcessRegistry.unwatch(p);
        }
      }
  finally {
        setState(State.NOT_RUNNING);
      }
    }
  }
,"EmulatorController: Process manager").start();
  try {
    latch.await();
  }
 catch (  final InterruptedException drop) {
    System.err.println("Interrupted while waiting for emulator to launch.");
  }
}
