{
  File tempFile=null;
  try {
    File parentDir=file.getParentFile();
    tempFile=File.createTempFile(file.getName(),null,parentDir);
    InputStream is=openStream(stream);
    BufferedInputStream bis=new BufferedInputStream(is,16384);
    FileOutputStream fos=new FileOutputStream(tempFile);
    BufferedOutputStream bos=new BufferedOutputStream(fos);
    byte[] buffer=new byte[8192];
    int bytesRead;
    while ((bytesRead=bis.read(buffer)) != -1) {
      bos.write(buffer,0,bytesRead);
    }
    bos.flush();
    bos.close();
    bos=null;
    if (!tempFile.renameTo(file)) {
      System.err.println("Could not rename temporary file " + tempFile.getAbsolutePath());
    }
  }
 catch (  IOException e) {
    if (tempFile != null) {
      tempFile.delete();
    }
    e.printStackTrace();
  }
}
