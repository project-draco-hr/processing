{
  debug("handleDraw() " + g + " "+ looping+ " "+ redraw);
  if (g != null && (looping || redraw)) {
    if (!g.canDraw()) {
      debug("g.canDraw() is false");
      return;
    }
    g.beginDraw();
    if (recorder != null) {
      recorder.beginDraw();
    }
    long now=System.nanoTime();
    if (frameCount == 0) {
      GraphicsConfiguration gc=getGraphicsConfiguration();
      if (gc == null)       return;
      GraphicsDevice displayDevice=getGraphicsConfiguration().getDevice();
      if (displayDevice == null)       return;
      Rectangle screenRect=displayDevice.getDefaultConfiguration().getBounds();
      displayWidth=screenRect.width;
      displayHeight=screenRect.height;
      try {
        setup();
      }
 catch (      RendererChangeException e) {
        return;
      }
      this.defaultSize=false;
    }
 else {
      double rate=1000000.0 / ((now - frameRateLastNanos) / 1000000.0);
      float instantaneousRate=(float)rate / 1000.0f;
      frameRate=(frameRate * 0.9f) + (instantaneousRate * 0.1f);
      if (frameCount != 0) {
        handleMethods("pre");
      }
      pmouseX=dmouseX;
      pmouseY=dmouseY;
      draw();
      dmouseX=mouseX;
      dmouseY=mouseY;
      dequeueMouseEvents();
      dequeueKeyEvents();
      handleMethods("draw");
      redraw=false;
    }
    g.endDraw();
    if (recorder != null) {
      recorder.endDraw();
    }
    repaint();
    getToolkit().sync();
    if (frameCount != 0) {
      handleMethods("post");
    }
    frameRateLastNanos=now;
    frameCount++;
  }
}
