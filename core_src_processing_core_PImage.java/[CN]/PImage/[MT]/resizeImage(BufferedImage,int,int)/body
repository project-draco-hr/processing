{
  int type=(img.getTransparency() == Transparency.OPAQUE) ? BufferedImage.TYPE_INT_RGB : BufferedImage.TYPE_INT_ARGB;
  BufferedImage outgoing=img;
  BufferedImage scratchImage=null;
  Graphics2D g2=null;
  int prevW=outgoing.getWidth();
  int prevH=outgoing.getHeight();
  boolean isTranslucent=img.getTransparency() != Transparency.OPAQUE;
  int w=img.getWidth();
  int h=img.getHeight();
  do {
    if (w > wide) {
      w/=2;
      if (w < wide) {
        w=wide;
      }
    }
    if (h > high) {
      h/=2;
      if (h < high) {
        h=high;
      }
    }
    if (scratchImage == null || isTranslucent) {
      scratchImage=new BufferedImage(w,h,type);
      g2=scratchImage.createGraphics();
    }
    g2.setRenderingHint(RenderingHints.KEY_INTERPOLATION,RenderingHints.VALUE_INTERPOLATION_BILINEAR);
    g2.drawImage(outgoing,0,0,w,h,0,0,prevW,prevH,null);
    prevW=w;
    prevH=h;
    outgoing=scratchImage;
  }
 while (w != wide || h != high);
  if (g2 != null) {
    g2.dispose();
  }
  if (wide != outgoing.getWidth() || high != outgoing.getHeight()) {
    scratchImage=new BufferedImage(wide,high,type);
    g2=scratchImage.createGraphics();
    g2.drawImage(outgoing,0,0,null);
    g2.dispose();
    outgoing=scratchImage;
  }
  return outgoing;
}
