{
  try {
    int outputFormat=(format == ARGB) ? BufferedImage.TYPE_INT_ARGB : BufferedImage.TYPE_INT_RGB;
    String extension=path.substring(path.lastIndexOf('.') + 1).toLowerCase();
    if (extension.equals("bmp") || extension.equals("jpg") || extension.equals("jpeg")) {
      outputFormat=BufferedImage.TYPE_INT_RGB;
    }
    BufferedImage bimage=new BufferedImage(width,height,outputFormat);
    bimage.setRGB(0,0,width,height,pixels,0,width);
    File file=new File(path);
    if (extension.equals("jpg") || extension.equals("jpeg")) {
      BufferedOutputStream output=new BufferedOutputStream(new FileOutputStream(file));
      JPEGImageEncoder encoder=JPEGCodec.createJPEGEncoder(output);
      JPEGEncodeParam param=encoder.getDefaultJPEGEncodeParam(bimage);
      param.setQuality(0.9f,true);
      encoder.setJPEGEncodeParam(param);
      encoder.encode(bimage);
      output.flush();
      output.close();
      return true;
    }
 else {
      return javax.imageio.ImageIO.write(bimage,extension,file);
    }
  }
 catch (  Exception e) {
    e.printStackTrace();
    throw new IOException("image save failed.");
  }
}
