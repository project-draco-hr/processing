{
  try {
    int outputFormat=(format == ARGB) ? BufferedImage.TYPE_INT_ARGB : BufferedImage.TYPE_INT_RGB;
    String extension=path.substring(path.lastIndexOf('.') + 1).toLowerCase();
    if (extension.equals("bmp") || extension.equals("jpg") || extension.equals("jpeg")) {
      outputFormat=BufferedImage.TYPE_INT_RGB;
    }
    BufferedImage bimage=new BufferedImage(width,height,outputFormat);
    bimage.setRGB(0,0,width,height,pixels,0,width);
    File file=new File(path);
    if (extension.equals("jpg") || extension.equals("jpeg")) {
      ImageWriter writer=null;
      Iterator<ImageWriter> iter=ImageIO.getImageWritersByFormatName("jpeg");
      if (iter.hasNext()) {
        writer=iter.next();
        ImageWriteParam param=writer.getDefaultWriteParam();
        param.setCompressionMode(ImageWriteParam.MODE_EXPLICIT);
        param.setCompressionQuality(0.9f);
        BufferedOutputStream output=new BufferedOutputStream(new FileOutputStream(file));
        writer.setOutput(ImageIO.createImageOutputStream(output));
        writer.write(null,new IIOImage(bimage,null,null),param);
        writer.dispose();
        output.flush();
        output.close();
        return true;
      }
    }
    return javax.imageio.ImageIO.write(bimage,extension,file);
  }
 catch (  Exception e) {
    e.printStackTrace();
    throw new IOException("image save failed.");
  }
}
