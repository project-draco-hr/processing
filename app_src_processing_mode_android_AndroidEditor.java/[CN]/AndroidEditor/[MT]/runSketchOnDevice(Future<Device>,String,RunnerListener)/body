{
  listener.startIndeterminate();
  listener.statusNotice("Creating project...");
  build=new AndroidBuild(sketch,amode.getSDK());
  try {
    try {
      if (build.createProject(target,amode.getCoreZipLocation()) == null) {
        return;
      }
    }
 catch (    SketchException se) {
      statusError(se);
    }
catch (    IOException e) {
      statusError(e);
    }
    try {
      listener.statusNotice("Building...");
      try {
        if (!build.antBuild(target)) {
          return;
        }
      }
 catch (      SketchException se) {
        statusError(se);
      }
      listener.statusNotice("Waiting for device to become available...");
      final Device device=waitForDevice(deviceFuture,listener);
      if (device == null || !device.isAlive()) {
        statusError("Device killed or disconnected.");
        return;
      }
      device.addListener(this);
      if (listener.isHalted()) {
        throw new MonitorCanceled();
      }
      statusNotice("Installing sketch on " + device.getId());
      if (!device.installApp(build.getPathForAPK(target),this)) {
        statusError("Device killed or disconnected.");
        return;
      }
      listener.statusNotice("Starting sketch on " + device.getId());
      if (startSketch(device)) {
        statusNotice("Sketch launched on the " + (device.isEmulator() ? "emulator" : "phone") + ".");
      }
 else {
        statusError("Could not start the sketch.");
      }
      lastRunDevice=device;
    }
  finally {
      build.cleanup();
    }
  }
  finally {
    listener.stopIndeterminate();
  }
}
