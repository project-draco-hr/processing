{
  PShader shader;
  boolean useDefault=polyShader == null;
  if (polyShader != null) {
    polyShader.setRenderer(this);
    polyShader.loadAttributes();
    polyShader.loadUniforms();
  }
  if (lit) {
    if (tex) {
      if (useDefault || !polyShader.checkPolyType(PShader.TEXLIGHT)) {
        if (defTexlightShader == null) {
          defTexlightShader=new PShader(parent,defTexlightShaderVertURL,defTextureShaderFragURL);
        }
        shader=defTexlightShader;
      }
 else {
        shader=polyShader;
      }
    }
 else {
      if (useDefault || !polyShader.checkPolyType(PShader.LIGHT)) {
        if (defLightShader == null) {
          defLightShader=new PShader(parent,defLightShaderVertURL,defColorShaderFragURL);
        }
        shader=defLightShader;
      }
 else {
        shader=polyShader;
      }
    }
  }
 else {
    if (polyShader != null && polyShader.accessLightAttribs()) {
      PGraphics.showWarning(SHADER_NEED_LIGHT_ATTRIBS);
      useDefault=true;
    }
    if (tex) {
      if (useDefault || !polyShader.checkPolyType(PShader.TEXTURE)) {
        if (defTextureShader == null) {
          defTextureShader=new PShader(parent,defTextureShaderVertURL,defTextureShaderFragURL);
        }
        shader=defTextureShader;
      }
 else {
        shader=polyShader;
      }
    }
 else {
      if (useDefault || !polyShader.checkPolyType(PShader.COLOR)) {
        if (defColorShader == null) {
          defColorShader=new PShader(parent,defColorShaderVertURL,defColorShaderFragURL);
        }
        shader=defColorShader;
      }
 else {
        shader=polyShader;
      }
    }
  }
  if (shader != polyShader) {
    shader.setRenderer(this);
    shader.loadAttributes();
    shader.loadUniforms();
  }
  return shader;
}
