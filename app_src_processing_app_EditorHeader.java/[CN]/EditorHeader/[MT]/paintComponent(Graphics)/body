{
  if (screen == null)   return;
  Sketch sketch=editor.getSketch();
  if (sketch == null)   return;
  Dimension size=getSize();
  if ((size.width != sizeW) || (size.height != sizeH)) {
    if ((size.width > imageW) || (size.height > imageH)) {
      offscreen=null;
    }
 else {
      sizeW=size.width;
      sizeH=size.height;
    }
  }
  if (offscreen == null) {
    sizeW=size.width;
    sizeH=size.height;
    imageW=sizeW;
    imageH=sizeH;
    offscreen=createImage(imageW,imageH);
  }
  Graphics g=offscreen.getGraphics();
  if (font == null) {
    font=Theme.getFont("header.text.font");
  }
  g.setFont(font);
  metrics=g.getFontMetrics();
  fontAscent=metrics.getAscent();
  g.setColor(backgroundColor);
  g.fillRect(0,0,imageW,imageH);
  int codeCount=sketch.getCodeCount();
  if ((tabLeft == null) || (tabLeft.length < codeCount)) {
    tabLeft=new int[codeCount];
    tabRight=new int[codeCount];
  }
  int x=6;
  for (int i=0; i < sketch.getCodeCount(); i++) {
    SketchCode code=sketch.getCode(i);
    String codeName=sketch.hideExtension(code.getExtension()) ? code.getPrettyName() : code.getFileName();
    String text="  " + codeName + (code.isModified() ? " \u00A7" : "  ");
    Graphics2D g2=(Graphics2D)g;
    int textWidth=(int)font.getStringBounds(text,g2.getFontRenderContext()).getWidth();
    int pieceCount=2 + (textWidth / PIECE_WIDTH);
    int pieceWidth=pieceCount * PIECE_WIDTH;
    int state=(code == sketch.getCurrentCode()) ? SELECTED : UNSELECTED;
    g.drawImage(pieces[state][LEFT],x,0,null);
    x+=PIECE_WIDTH;
    int contentLeft=x;
    tabLeft[i]=x;
    for (int j=0; j < pieceCount; j++) {
      g.drawImage(pieces[state][MIDDLE],x,0,null);
      x+=PIECE_WIDTH;
    }
    tabRight[i]=x;
    int textLeft=contentLeft + (pieceWidth - textWidth) / 2;
    g.setColor(textColor[state]);
    int baseline=(sizeH + fontAscent) / 2;
    g.drawString(text,textLeft,baseline);
    g.drawImage(pieces[state][RIGHT],x,0,null);
    x+=PIECE_WIDTH - 1;
  }
  menuLeft=sizeW - (16 + pieces[0][MENU].getWidth(this));
  menuRight=sizeW - 16;
  g.drawImage(pieces[popup.isVisible() ? SELECTED : UNSELECTED][MENU],menuLeft,0,null);
  screen.drawImage(offscreen,0,0,null);
}
