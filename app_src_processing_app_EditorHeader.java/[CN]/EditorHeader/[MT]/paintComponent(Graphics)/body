{
  if (screen == null)   return;
  Sketch sketch=editor.getSketch();
  if (sketch == null)   return;
  Dimension size=getSize();
  if ((size.width != sizeW) || (size.height != sizeH)) {
    if ((size.width > imageW) || (size.height > imageH)) {
      offscreen=null;
    }
 else {
      sizeW=size.width;
      sizeH=size.height;
    }
  }
  if (offscreen == null) {
    sizeW=size.width;
    sizeH=size.height;
    imageW=sizeW;
    imageH=sizeH;
    if (Toolkit.isRetina()) {
      offscreen=createImage(imageW * 2,imageH * 2);
    }
 else {
      offscreen=createImage(imageW,imageH);
    }
  }
  Graphics g=offscreen.getGraphics();
  g.setFont(font);
  metrics=g.getFontMetrics();
  fontAscent=metrics.getAscent();
  Graphics2D g2=(Graphics2D)g;
  if (Toolkit.isRetina()) {
    g2.scale(2,2);
  }
 else {
    g2.setRenderingHint(RenderingHints.KEY_TEXT_ANTIALIASING,RenderingHints.VALUE_TEXT_ANTIALIAS_ON);
  }
  g.setColor(backgroundColor);
  g.fillRect(0,0,imageW,imageH);
  if (tabs.length != sketch.getCodeCount()) {
    tabs=new Tab[sketch.getCodeCount()];
    for (int i=0; i < tabs.length; i++) {
      tabs[i]=new Tab(i);
    }
    visitOrder=new Tab[sketch.getCodeCount() - 1];
  }
  menuRight=sizeW - 16;
  menuLeft=menuRight - 50;
  int tabLeft=6;
  int tabMax=menuLeft - tabLeft;
  for (  Tab tab : tabs) {
    SketchCode code=sketch.getCode(tab.index);
    tab.textVisible=true;
    tab.lastVisited=code.lastVisited();
    boolean hide=editor.getMode().hideExtension(code.getExtension());
    String codeName=hide ? code.getPrettyName() : code.getFileName();
    tab.text="  " + codeName + (code.isModified() ? " \u00A7" : "  ");
    tab.textWidth=(int)font.getStringBounds(tab.text,g2.getFontRenderContext()).getWidth();
  }
  if (!placeTabs(tabLeft,tabMax,null)) {
    int index=0;
    for (int i=tabs.length - 1; i > 0; --i) {
      visitOrder[index++]=tabs[i];
    }
    Arrays.sort(visitOrder);
    for (int i=0; i < visitOrder.length; i++) {
      tabs[visitOrder[i].index].textVisible=false;
      if (placeTabs(tabLeft,tabMax,null)) {
        break;
      }
    }
  }
  placeTabs(tabLeft,tabMax,g);
  screen.drawImage(offscreen,0,0,imageW,imageH,null);
}
