{
  final IndeterminateProgressMonitor monitor=new IndeterminateProgressMonitor(editor,"Building and launching...","Creating project...");
  try {
    final Build build=getBuilder();
    if (!build.createProject()) {
      return;
    }
    if (monitor.isCanceled()) {
      throw new Cancelled();
    }
    monitor.setNote("Building...");
    if (!build.antBuild("debug")) {
      return;
    }
    if (monitor.isCanceled()) {
      throw new Cancelled();
    }
    monitor.setNote("Waiting for device to become available...");
    final AndroidDevice device=waitForDevice(deviceFuture,monitor);
    if (device == null || !device.isAlive()) {
      editor.statusError("Device killed or disconnected.");
      return;
    }
    device.addListener(this);
    if (monitor.isCanceled()) {
      throw new Cancelled();
    }
    monitor.setNote("Installing sketch on " + device.getId());
    if (!device.installApp(build.getPathForAPK("debug"),editor)) {
      editor.statusError("Device killed or disconnected.");
      return;
    }
    if (monitor.isCanceled()) {
      throw new Cancelled();
    }
    monitor.setNote("Starting sketch on " + device.getId());
    if (startSketch(device)) {
      editor.statusNotice("Sketch launched on the " + (device.isEmulator() ? "emulator" : "phone") + ".");
    }
 else {
      editor.statusError("Could not start the sketch.");
    }
    lastRunDevice=device;
  }
  finally {
    monitor.close();
  }
}
