{
  if (DEBUG) {
    println("inside handleDraw() " + millis() + " changed="+ surfaceChanged+ " ready="+ surfaceReady+ " paused="+ paused+ " looping="+ looping+ " redraw="+ redraw);
  }
  if (surfaceChanged) {
    int newWidth=surfaceView.getWidth();
    int newHeight=surfaceView.getHeight();
    if (newWidth != width || newHeight != height) {
      width=newWidth;
      height=newHeight;
      g.setSize(width,height);
    }
    surfaceChanged=false;
    surfaceReady=true;
    if (DEBUG) {
      println("surfaceChanged true, resized to " + width + "x"+ height);
    }
  }
  if (g != null && surfaceReady && !paused && (looping || redraw)) {
    g.beginDraw();
    long now=System.nanoTime();
    if (frameCount == 0) {
      try {
        setup();
      }
 catch (      RendererChangeException e) {
        return;
      }
    }
 else {
      double rate=1000000.0 / ((now - frameRateLastNanos) / 1000000.0);
      float instantaneousRate=(float)rate / 1000.0f;
      frameRate=(frameRate * 0.9f) + (instantaneousRate * 0.1f);
      if (frameCount != 0) {
        handleMethods("pre");
      }
      pmouseX=dmouseX;
      pmouseY=dmouseY;
      pmotionX=dmotionX;
      pmotionY=dmotionY;
      draw();
      dmouseX=mouseX;
      dmouseY=mouseY;
      dmotionX=motionX;
      dmotionY=motionY;
      dequeueEvents();
      handleMethods("draw");
      redraw=false;
    }
    g.endDraw();
    if (frameCount != 0) {
      handleMethods("post");
    }
    frameRateLastNanos=now;
    frameCount++;
  }
}
