{
  programImports=new ArrayList<ImportStatement>();
  StringBuilder rawCode=new StringBuilder();
  try {
    for (    SketchCode sc : editor.getSketch().getCode()) {
      if (sc.isExtension("pde")) {
        try {
          if (editor.getSketch().getCurrentCode().equals(sc)) {
            rawCode.append(scrapImportStatements(sc.getDocument().getText(0,sc.getDocument().getLength()),editor.getSketch().getCodeIndex(sc)));
          }
 else {
            rawCode.append(scrapImportStatements(sc.getProgram(),editor.getSketch().getCodeIndex(sc)));
          }
          rawCode.append('\n');
        }
 catch (        Exception e) {
          System.err.println("Exception in preprocessCode() - bigCode " + e.toString());
        }
        rawCode.append('\n');
      }
    }
  }
 catch (  Exception e) {
    Base.log("Exception in preprocessCode()");
  }
  String sourceAlt=rawCode.toString();
  String dataTypeFunc[]={"int","char","float","boolean","byte"};
  for (  String dataType : dataTypeFunc) {
    String dataTypeRegexp="\\b" + dataType + "\\s*\\(";
    Pattern pattern=Pattern.compile(dataTypeRegexp);
    Matcher matcher=pattern.matcher(sourceAlt);
    sourceAlt=matcher.replaceAll("PApplet.parse" + Character.toUpperCase(dataType.charAt(0)) + dataType.substring(1)+ "(");
  }
  final String webColorRegexp="#{1}[A-F|a-f|0-9]{6}\\W";
  Pattern webPattern=Pattern.compile(webColorRegexp);
  Matcher webMatcher=webPattern.matcher(sourceAlt);
  while (webMatcher.find()) {
    String found=sourceAlt.substring(webMatcher.start(),webMatcher.end());
    sourceAlt=webMatcher.replaceFirst("0xff" + found.substring(1));
    webMatcher=webPattern.matcher(sourceAlt);
  }
  final String colorTypeRegex="color(?![a-zA-Z0-9_])(?=\\[*)(?!(\\s*\\())";
  Pattern colorPattern=Pattern.compile(colorTypeRegex);
  Matcher colorMatcher=colorPattern.matcher(sourceAlt);
  sourceAlt=colorMatcher.replaceAll("int");
  checkForChangedImports();
  className=(editor == null) ? "DefaultClass" : editor.getSketch().getName();
  Matcher matcher=FUNCTION_DECL.matcher(sourceAlt);
  if (!matcher.find()) {
    sourceAlt=xqpreproc.prepareImports(programImports) + "public class " + className+ " extends PApplet {\n"+ "public void setup() {\n"+ sourceAlt+ "\nnoLoop();\n}\n"+ "\n}\n";
    staticMode=true;
  }
 else {
    sourceAlt=xqpreproc.prepareImports(programImports) + "public class " + className+ " extends PApplet {\n"+ sourceAlt+ "\n}";
    staticMode=false;
  }
  int position=sourceAlt.indexOf("{") + 1;
  mainClassOffset=1;
  for (int i=0; i <= position; i++) {
    if (sourceAlt.charAt(i) == '\n') {
      mainClassOffset++;
    }
  }
  if (staticMode) {
    mainClassOffset++;
  }
  sourceAlt=substituteUnicode(sourceAlt);
  sourceCode=sourceAlt;
  return sourceAlt;
}
