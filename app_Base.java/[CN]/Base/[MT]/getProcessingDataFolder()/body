{
  File dataFolder=null;
  String pref=Preferences.get("settings.path");
  if (pref != null) {
    dataFolder=new File(pref);
  }
 else   if (Base.isMacOS()) {
    try {
      MRJOSType domainLibrary=new MRJOSType("dlib");
      Method findFolderMethod=MRJFileUtils.class.getMethod("findFolder",new Class[]{Short.TYPE,MRJOSType.class});
      File libraryFolder=(File)findFolderMethod.invoke(null,new Object[]{new Short(kUserDomain),domainLibrary});
      dataFolder=new File(libraryFolder,"Processing");
    }
 catch (    Exception e) {
      showError("Problem getting data folder","Error getting the Processing data folder.",e);
    }
  }
 else   if (Base.isWindows()) {
    try {
      RegistryKey topKey=Registry.HKEY_CURRENT_USER;
      String localKeyPath="Software\\Microsoft\\Windows\\CurrentVersion" + "\\Explorer\\Shell Folders";
      RegistryKey localKey=topKey.openSubKey(localKeyPath);
      String appDataPath=localKey.getStringValue("AppData");
      dataFolder=new File(appDataPath,"Processing");
    }
 catch (    Exception e) {
      showError("Problem getting data folder","Error getting the Processing data folder.",e);
    }
  }
 else {
    File home=new File(System.getProperty("user.home"));
    dataFolder=new File(home,".processing");
  }
  boolean result=true;
  if (!dataFolder.exists()) {
    result=dataFolder.mkdirs();
  }
  if (!result) {
    String fallback=Preferences.get("settings.path.fallback");
    dataFolder=new File(fallback);
    if (!dataFolder.exists()) {
      result=dataFolder.mkdirs();
    }
  }
  if (!result) {
    showError("Settings issues","Processing cannot run because it could not\n" + "create a folder to store your settings.",null);
  }
  return dataFolder;
}
