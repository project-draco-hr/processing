{
  ArrayList<Library> oldLibs=editor.getMode().contribLibraries;
  String libFolderName=newLib.getFolder().getName();
  File libraryDestination=editor.getBase().getSketchbookLibrariesFolder();
  File newLibDest=new File(libraryDestination,libFolderName);
  for (  Library oldLib : oldLibs) {
    if (oldLib.getFolder().exists() && oldLib.getFolder().equals(newLibDest)) {
      int result=0;
      boolean doBackup=Preferences.getBoolean("contribution.backup.on_install");
      if (confirmReplace) {
        if (doBackup) {
          result=Base.showYesNoQuestion(editor,"Replace","Replace pre-existing \"" + oldLib.getName() + "\" library?","A pre-existing copy of the \"" + oldLib.getName() + "\" library<br>"+ "has been found in your sketchbook. Clicking ???Yes???<br>"+ "will move the existing library to a backup folder<br>"+ " in <i>libraries/old</i> before replacing it.");
          if (result != JOptionPane.YES_OPTION || !backupContribution(editor,oldLib,true,statusBar)) {
            return null;
          }
        }
 else {
          result=Base.showYesNoQuestion(editor,"Replace","Replace pre-existing \"" + oldLib.getName() + "\" library?","A pre-existing copy of the \"" + oldLib.getName() + "\" library<br>"+ "has been found in your sketchbook. Clicking ???Yes???<br>"+ "will permanently delete this library and all of its contents<br>"+ "before replacing it.");
          if (result != JOptionPane.YES_OPTION || !oldLib.getFolder().delete()) {
            return null;
          }
        }
      }
 else {
        if (doBackup && !backupContribution(editor,oldLib,true,statusBar) || !doBackup && !oldLib.getFolder().delete()) {
          return null;
        }
      }
    }
  }
  if (newLib.getFolder().renameTo(newLibDest)) {
    return new Library(newLibDest,null);
  }
 else {
    statusBar.setErrorMessage("Could not move library \"" + newLib.getName() + "\" to sketchbook.");
    return null;
  }
}
