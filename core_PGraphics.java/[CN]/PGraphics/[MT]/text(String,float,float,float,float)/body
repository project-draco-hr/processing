{
  if (textFont == null) {
    throw new RuntimeException("use textFont() before text()");
  }
  if (textMode == SCREEN)   beginPixels();
  float hradius, vradius;
switch (rectMode) {
case CORNER:
    x2+=x1;
  y2+=y1;
break;
case CENTER_RADIUS:
hradius=x2;
vradius=y2;
x2=x1 + hradius;
y2=y1 + vradius;
x1-=hradius;
y1-=vradius;
break;
case CENTER:
hradius=x2 / 2.0f;
vradius=y2 / 2.0f;
x2=x1 + hradius;
y2=y1 + vradius;
x1-=hradius;
y1-=vradius;
}
if (x2 < x1) {
float temp=x1;
x1=x2;
x2=temp;
}
if (y2 < y1) {
float temp=y1;
y1=y2;
y2=temp;
}
float spaceWidth=textWidth(' ');
float runningX=x1;
float currentY=y1;
float boxWidth=x2 - x1;
float lineX=x1;
if (textAlign == CENTER) {
lineX=lineX + boxWidth / 2f;
}
 else if (textAlign == RIGHT) {
lineX=x2;
}
currentY+=textAscent();
if (currentY > y2) return;
int length=str.length();
if (length > textBuffer.length) {
textBuffer=new char[length + 10];
}
str.getChars(0,length,textBuffer,0);
int wordStart=0;
int wordStop=0;
int lineStart=0;
int index=0;
while (index < length) {
if ((textBuffer[index] == ' ') || (index == length - 1)) {
float wordWidth=textWidthImpl(textBuffer,wordStart,index);
if (runningX + wordWidth > x2) {
if (runningX == x1) {
do {
index--;
if (index == wordStart) {
return;
}
wordWidth=textWidthImpl(textBuffer,wordStart,index);
}
 while (wordWidth > boxWidth);
textLineImpl(textBuffer,lineStart,index,lineX,currentY);
}
 else {
textLineImpl(textBuffer,lineStart,wordStop,lineX,currentY);
index=wordStop;
while ((index < length) && (textBuffer[index] == ' ')) {
index++;
}
}
lineStart=index;
wordStart=index;
wordStop=index;
runningX=x1;
currentY+=textLeading;
if (currentY > y2) return;
}
 else {
runningX+=wordWidth + spaceWidth;
wordStop=index;
wordStart=index + 1;
}
}
 else if (textBuffer[index] == '\n') {
if (lineStart != index) {
textLineImpl(textBuffer,lineStart,index,lineX,currentY);
}
lineStart=index + 1;
wordStart=lineStart;
runningX=x1;
currentY+=textLeading;
if (currentY > y2) return;
}
index++;
}
if ((lineStart < length) && (lineStart != index)) {
textLineImpl(textBuffer,lineStart,index,lineX,currentY);
}
if (textMode == SCREEN) endPixels();
}
