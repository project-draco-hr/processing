{
  if (screen == null)   return;
  Dimension size=getSize();
  if ((size.width != sizeW) || (size.height != sizeH)) {
    if ((size.width > imageW) || (size.height > imageH)) {
      offscreen=null;
    }
 else {
      sizeW=size.width;
      sizeH=size.height;
    }
  }
  if (offscreen == null) {
    sizeW=size.width;
    sizeH=size.height;
    imageW=sizeW;
    imageH=sizeH;
    offscreen=createImage(imageW,imageH);
  }
  Graphics g=offscreen.getGraphics();
  if (font == null) {
    font=PdePreferences.getFont("header.text.font");
    g.setFont(font);
    metrics=g.getFontMetrics();
    fontAscent=metrics.getAscent();
  }
  if ((tabLeft == null) || (tabLeft.length < sketch.codeCount)) {
    tabLeft=new int[sketch.codeCount];
    tabRight=new int[sketch.codeCount];
  }
  int x=PdePreferences.GUI_SMALL;
  for (int i=0; i < sketch.codeCount; i++) {
    PdeCode code=sketch.code[i];
    String text="  " + code.name + (code.modified ? " \u00A7" : "  ");
    int textWidth=metrics.stringWidth(text);
    int pieceCount=2 + (textWidth / PIECE_WIDTH);
    int pieceWidth=pieceCount * PIECE_WIDTH;
    int state=(code == sketch.current) ? SELECTED : UNSELECTED;
    g.drawImage(pieces[state][LEFT],x,0,null);
    x+=PIECE_WIDTH;
    int contentLeft=x;
    tabLeft[i]=x;
    for (int j=0; j < pieceCount; j++) {
      g.drawImage(pieces[state][MIDDLE],x,0,null);
      x+=PIECE_WIDTH;
    }
    tabRight[i]=x;
    int textLeft=contentLeft + (pieceWidth - textWidth) / 2;
    g.setColor(textColor[state]);
    int baseline=(sizeH + fontAscent) / 2;
    g.drawString(text,textLeft,baseline);
    g.drawImage(pieces[state][RIGHT],x,0,null);
    x+=PIECE_WIDTH - 1;
  }
  menuLeft=sizeW - (16 + pieces[0][MENU].getWidth(this));
  menuRight=sizeW - 16;
  g.drawImage(pieces[popup.isVisible() ? SELECTED : UNSELECTED][MENU],menuLeft,0,null);
  screen.drawImage(offscreen,0,0,null);
}
