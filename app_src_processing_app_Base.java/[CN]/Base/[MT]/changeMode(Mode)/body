{
  if (activeEditor.getMode() != mode) {
    Sketch sketch=activeEditor.getSketch();
    nextMode=mode;
    if (sketch.isUntitled()) {
      handleClose(activeEditor,true);
      handleNew();
    }
 else {
      boolean newModeCanHandleCurrentSource=true;
      for (      final SketchCode code : sketch.getCode()) {
        if (!mode.validExtension(code.getExtension())) {
          newModeCanHandleCurrentSource=false;
          break;
        }
      }
      if (newModeCanHandleCurrentSource) {
        final File props=new File(sketch.getCodeFolder(),"sketch.properties");
        saveModeSettings(props,nextMode);
        handleClose(activeEditor,true);
        handleOpen(sketch.getMainFilePath());
      }
    }
  }
}
