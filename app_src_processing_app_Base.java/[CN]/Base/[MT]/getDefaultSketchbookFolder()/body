{
  File sketchbookFolder=null;
  if (Base.isMacOS()) {
    try {
      Class clazz=Class.forName("processing.app.BaseMacOS");
      Method m=clazz.getMethod("getDocumentsFolder",new Class[]{});
      String documentsPath=(String)m.invoke(null,new Object[]{});
      sketchbookFolder=new File(documentsPath,"Processing");
    }
 catch (    Exception e) {
      sketchbookFolder=promptSketchbookLocation();
    }
  }
 else   if (isWindows()) {
    try {
      RegistryKey topKey=Registry.HKEY_CURRENT_USER;
      String localKeyPath="Software\\Microsoft\\Windows\\CurrentVersion" + "\\Explorer\\Shell Folders";
      RegistryKey localKey=topKey.openSubKey(localKeyPath);
      String personalPath=cleanKey(localKey.getStringValue("Personal"));
      sketchbookFolder=new File(personalPath,"Processing");
    }
 catch (    Exception e) {
      sketchbookFolder=promptSketchbookLocation();
    }
  }
 else {
    sketchbookFolder=promptSketchbookLocation();
  }
  boolean result=true;
  if (!sketchbookFolder.exists()) {
    result=sketchbookFolder.mkdirs();
  }
  if (!result) {
    System.out.println("Using fallback path for sketchbook.");
    String fallback=Preferences.get("sketchbook.path.fallback");
    sketchbookFolder=new File(fallback);
    if (!sketchbookFolder.exists()) {
      result=sketchbookFolder.mkdirs();
    }
  }
  if (!result) {
    showError("error","Processing cannot run because it could not\n" + "create a folder to store your sketchbook.",null);
  }
  return sketchbookFolder;
}
