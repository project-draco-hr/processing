{
  message("Saving file...");
  String s=textarea.getText();
  String directory=sketchFile.getParent();
  String filename=sketchFile.getName();
  if (promptUser) {
    FileDialog fd=new FileDialog(new Frame(),"Save PDE program as...",FileDialog.SAVE);
    fd.setDirectory(directory);
    fd.setFile(filename);
    fd.show();
    directory=fd.getDirectory();
    filename=fd.getFile();
    if (filename == null) {
      message(EMPTY);
      buttons.clear();
      return;
    }
  }
  makeHistory(s,SAVE);
  File file=new File(directory,filename);
  try {
    BufferedReader reader=new BufferedReader(new InputStreamReader(new ByteArrayInputStream(s.getBytes())));
    PrintWriter writer=new PrintWriter(new BufferedWriter(new FileWriter(file)));
    String line=null;
    while ((line=reader.readLine()) != null) {
      writer.println(line);
    }
    writer.flush();
    writer.close();
    sketchFile=file;
    setSketchModified(false);
    message("Done saving " + filename + ".");
  }
 catch (  IOException e) {
    e.printStackTrace();
    message("Could not write " + filename + ".");
  }
  buttons.clear();
}
