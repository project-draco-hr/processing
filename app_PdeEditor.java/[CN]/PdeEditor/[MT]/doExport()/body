{
  message("Exporting to applet...");
  String s=textarea.getText();
  FileDialog fd=new FileDialog(new Frame(),"Create applet project named...",FileDialog.SAVE);
  fd.setDirectory(lastDirectory);
  fd.setFile(lastFile);
  fd.show();
  String directory=fd.getDirectory();
  String projectName=fd.getFile();
  if (projectName == null) {
    message(EMPTY);
    buttons.clear();
    return;
  }
 else   if (projectName.indexOf(' ') != -1) {
    message("Project name cannot have spaces.");
    buttons.clear();
    return;
  }
  try {
    String program=textarea.getText();
    KjcEngine engine=new KjcEngine(program,this);
    File projectDir=new File(directory,projectName);
    projectDir.mkdirs();
    engine.writeJava(projectName,false);
    if (!engine.compileJava())     return;
    String javaName=projectName + ".java";
    copyFile(new File(javaName),new File(projectDir,javaName));
    int wide=320;
    int high=240;
    int index=program.indexOf("size(");
    if (index != -1) {
      try {
        String str=program.substring(index + 5);
        int comma=str.indexOf(',');
        int paren=str.indexOf(')');
        wide=Integer.parseInt(str.substring(0,comma).trim());
        high=Integer.parseInt(str.substring(comma + 1,paren).trim());
      }
 catch (      Exception e) {
        e.printStackTrace();
      }
    }
    File htmlOutputFile=new File(projectDir,"index.html");
    FileOutputStream fos=new FileOutputStream(htmlOutputFile);
    PrintStream ps=new PrintStream(fos);
    ps.println("<HTML> <BODY BGCOLOR=\"white\">");
    ps.println();
    ps.println("<BR> <BR> <BR> <CENTER>");
    ps.println();
    ps.print("<APPLET CODE=\"" + projectName + "\" ARCHIVE=\"");
    ps.print(projectName + ".jar");
    ps.println("\" WIDTH=" + wide + " HEIGHT="+ high+ ">");
    ps.println("</APPLET>");
    ps.println();
    ps.println("<A HREF=\"" + projectName + ".java\">source code</A>");
    ps.println();
    ps.println("</CENTER>");
    ps.println("</BODY> </HTML>");
    ps.flush();
    ps.close();
    final String classes[]={"Bagel.class","BagelConstants.class","BagelFont.class","BagelImage.class","BagelLight.class","BagelPolygon.class","ProcessingApplet.class"};
    FileOutputStream zipOutputFile=new FileOutputStream(new File(projectDir,projectName + ".jar"));
    ZipOutputStream zos=new ZipOutputStream(zipOutputFile);
    ZipEntry entry;
    for (int i=0; i < classes.length; i++) {
      entry=new ZipEntry(classes[i]);
      zos.putNextEntry(entry);
      zos.write(grabFile(new File("lib" + File.separator + "export"+ File.separator+ classes[i])));
      zos.closeEntry();
    }
    entry=new ZipEntry(projectName + ".class");
    zos.putNextEntry(entry);
    zos.write(grabFile(new File("lib",projectName + ".class")));
    zos.closeEntry();
    zos.flush();
    zos.close();
    engine.cleanup();
    message("Done exporting.");
  }
 catch (  Exception e) {
    message("Error during export.");
    e.printStackTrace();
  }
  buttons.clear();
}
