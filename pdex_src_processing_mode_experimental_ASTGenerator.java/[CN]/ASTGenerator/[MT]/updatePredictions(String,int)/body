{
  SwingWorker worker=new SwingWorker(){
    @Override protected Object doInBackground() throws Exception {
      return null;
    }
    protected void done(){
      String word2=word;
      boolean noCompare=false;
      if (word2.endsWith(".")) {
        word2=word2.substring(0,word.length() - 1);
        noCompare=true;
      }
      int lineNumber=line;
      if (errorCheckerService != null) {
        editor=errorCheckerService.getEditor();
        int codeIndex=editor.getSketch().getCodeIndex(editor.getCurrentTab());
        if (codeIndex > 0)         for (int i=0; i < codeIndex; i++) {
          SketchCode sc=editor.getSketch().getCode(i);
          int len=Base.countLines(sc.getProgram()) + 1;
          lineNumber+=len;
        }
      }
      ASTNode anode=null;
      ASTParser parser=ASTParser.newParser(AST.JLS4);
      parser.setKind(ASTParser.K_EXPRESSION);
      parser.setSource(word2.toCharArray());
      ASTNode testnode=parser.createAST(null);
      System.err.print("Typed: " + word2 + "|");
      anode=findClosestNode(lineNumber,(ASTNode)compilationUnit.types().get(0));
      System.err.println(lineNumber + " Nearest ASTNode to PRED " + getNodeAsString(anode));
      ArrayList<CompletionCandidate> candidates=new ArrayList<CompletionCandidate>();
      if (testnode instanceof SimpleName && !noCompare) {
        System.err.println("One word expression " + getNodeAsString(testnode));
        anode=anode.getParent();
        while (anode != null) {
          if (anode instanceof TypeDeclaration) {
            TypeDeclaration td=(TypeDeclaration)anode;
            if (td.getStructuralProperty(TypeDeclaration.SUPERCLASS_TYPE_PROPERTY) != null) {
              SimpleType st=(SimpleType)td.getStructuralProperty(TypeDeclaration.SUPERCLASS_TYPE_PROPERTY);
              System.out.println("Superclass " + st.getName());
              for (              CompletionCandidate can : getMembersForType(st.getName().toString(),word2,noCompare)) {
                candidates.add(can);
              }
            }
          }
          List<StructuralPropertyDescriptor> sprops=anode.structuralPropertiesForType();
          for (          StructuralPropertyDescriptor sprop : sprops) {
            ASTNode cnode=null;
            if (!sprop.isChildListProperty()) {
              if (anode.getStructuralProperty(sprop) instanceof ASTNode) {
                cnode=(ASTNode)anode.getStructuralProperty(sprop);
                CompletionCandidate[] types=checkForTypes(cnode);
                if (types != null) {
                  for (int i=0; i < types.length; i++) {
                    if (types[i].getElementName().startsWith(word2))                     candidates.add(types[i]);
                  }
                }
              }
            }
 else {
              List<ASTNode> nodelist=(List<ASTNode>)anode.getStructuralProperty(sprop);
              for (              ASTNode clnode : nodelist) {
                CompletionCandidate[] types=checkForTypes(clnode);
                if (types != null) {
                  for (int i=0; i < types.length; i++) {
                    if (types[i].getElementName().startsWith(word2))                     candidates.add(types[i]);
                  }
                }
              }
            }
          }
          anode=anode.getParent();
        }
      }
 else {
        System.err.println("Complex expression " + getNodeAsString(testnode));
        ASTNode det=resolveExpression(anode,testnode);
        System.err.println("DET " + getNodeAsString(det));
        if (det != null) {
          TypeDeclaration td=null;
          SimpleType stp=null;
          if (det instanceof MethodDeclaration) {
            if (((MethodDeclaration)det).getReturnType2() instanceof SimpleType) {
              stp=(SimpleType)(((MethodDeclaration)det).getReturnType2());
              td=(TypeDeclaration)findDeclaration(stp.getName());
            }
          }
 else           if (det instanceof FieldDeclaration) {
            if (((FieldDeclaration)det).getType() instanceof SimpleType) {
              stp=(SimpleType)(((FieldDeclaration)det).getType());
              td=(TypeDeclaration)findDeclaration(stp.getName());
            }
          }
 else           if (det instanceof VariableDeclarationStatement) {
            stp=(SimpleType)(((VariableDeclarationStatement)det).getType());
            td=(TypeDeclaration)findDeclaration(stp.getName());
          }
          System.out.println("ST is " + stp.getName());
          System.err.println(getNodeAsString(det) + " defined in " + getNodeAsString(td));
          ASTNode child=resolveChildExpression(testnode);
          if (td != null) {
            System.out.println("Completion candidate: " + getNodeAsString(child));
            for (int i=0; i < td.getFields().length; i++) {
              List<VariableDeclarationFragment> vdfs=td.getFields()[i].fragments();
              for (              VariableDeclarationFragment vdf : vdfs) {
                if (noCompare) {
                  candidates.add(new CompletionCandidate(getNodeAsString2(vdf)));
                }
 else                 if (vdf.getName().toString().startsWith(child.toString()))                 candidates.add(new CompletionCandidate(getNodeAsString2(vdf)));
              }
            }
            for (int i=0; i < td.getMethods().length; i++) {
              if (noCompare) {
                candidates.add(new CompletionCandidate(getNodeAsString2(td.getMethods()[i]),td.getName().toString()));
              }
 else               if (td.getMethods()[i].getName().toString().startsWith(child.toString()))               candidates.add(new CompletionCandidate(getNodeAsString2(td.getMethods()[i]),td.getName().toString()));
            }
          }
 else {
            if (stp != null) {
              candidates=getMembersForType(stp.getName().toString(),child.toString(),noCompare);
            }
          }
        }
      }
      CompletionCandidate[][] candi=new CompletionCandidate[candidates.size()][1];
      for (int i=0; i < candi.length; i++) {
        candi[i][0]=candidates.get(i);
      }
      System.out.println("K = " + candidates.size());
      DefaultTableModel tm=new DefaultTableModel(candi,new String[]{"Suggestions"});
      tableAuto.setModel(tm);
      tableAuto.validate();
      tableAuto.repaint();
      CompletionCandidate[] candi2=candidates.toArray(new CompletionCandidate[candidates.size()]);
      if (candidates.size() > 0)       errorCheckerService.getEditor().textArea().showSuggestion(candi2);
    }
  }
;
  worker.execute();
}
