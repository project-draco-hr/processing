{
  String newName=txtRenameField.getText();
  String selText=lastClickedWord == null ? editor.ta.getSelectedText() : lastClickedWord;
  DefaultMutableTreeNode defCU=findAllOccurrences();
  if (defCU == null) {
    editor.statusError("Can't locate definition of " + selText);
    return;
  }
  treeRename.setModel(new DefaultTreeModel(defCU));
  ((DefaultTreeModel)treeRename.getModel()).reload();
  frmOccurenceList.setTitle("Usage of " + selText);
  frmOccurenceList.setVisible(true);
  int lineOffsetDisplacementConst=newName.length() - selText.length();
  HashMap<Integer,Integer> lineOffsetDisplacement=new HashMap<Integer,Integer>();
  int offsetsMap[][][]=new int[defCU.getChildCount()][2][];
  for (int i=defCU.getChildCount() - 1; i >= 0; i--) {
    ASTNodeWrapper awrap=(ASTNodeWrapper)((DefaultMutableTreeNode)(defCU.getChildAt(i))).getUserObject();
    offsetsMap[i][0]=awrap.getPDECodeOffsets(errorCheckerService);
    offsetsMap[i][1]=awrap.getJavaCodeOffsets(errorCheckerService);
  }
  for (int i=defCU.getChildCount() - 1; i >= 0; i--) {
    int pdeoffsets[]=offsetsMap[i][0];
    int javaoffsets[]=offsetsMap[i][1];
    int off=0;
    if (lineOffsetDisplacement.get(javaoffsets[0]) != null) {
      off=lineOffsetDisplacement.get(javaoffsets[0]);
      lineOffsetDisplacement.put(javaoffsets[0],lineOffsetDisplacementConst + off);
    }
 else {
      lineOffsetDisplacement.put(javaoffsets[0],lineOffsetDisplacementConst);
    }
    ErrorCheckerService.scrollToErrorLine(editor,pdeoffsets[0],pdeoffsets[1],javaoffsets[1] + off,javaoffsets[2]);
    editor.ta.setSelectedText(newName);
  }
  for (  Integer lineNum : lineOffsetDisplacement.keySet()) {
    log(lineNum + "line, disp" + lineOffsetDisplacement.get(lineNum));
  }
  editor.getSketch().setModified(true);
  errorCheckerService.runManualErrorCheck();
  frmOccurenceList.setVisible(false);
  frmRename.setVisible(false);
  lastClickedWord=null;
  lastClickedWordNode=null;
}
